<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<style>
    .container{
        width: 650px;
        height: 500px;
        background-color: aliceblue;
        margin: auto;
    }
    .aside{
        width: 150px;
        height: 100%;
        background-color: antiquewhite;
        float: left;
    }
    .content{
        width: 500px;  
        height: 100%;
        background-color: rgb(201, 163, 106);
        float: left;
    }
    .aside input{
        width: 90%;
        
    }
    .aside button{
        width: 45%;
        height: 10%;
    }
</style>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
/* 목록을 출력하는 작업은 꼭 등록할 때 뿐만이 아니라.  */

	//서버에 목록 요청(비동기적)
	function getList(){
		//비동기적 요청을 담당하는 XMLHttpRequest 객체를 사용
		let xhttp = new XMLHttpRequest();
		
		//서버의 응답이 도달하면 지정한 익명함수가 호출( by javascript)
		xhttp.onload = function(){
			//서버에서 전송한 json 문자열을 파싱하여 화면에 렌더링 하자.
			console.log("서버가 응답한 데이터는",this.responseText);
			//파싱시 주의점 ! 반드시 문자열이 JSON 표기법을 따른 것만이 파싱에 성공함
			let memberList = JSON.parse(this.responseText);
			//화면에 렌더링
			render(memberList);
		}
		xhttp.open("GET","/ajax/async_list.jsp");	//요청 준비
		xhttp.send(); // 여기서 요청발생..	
		
	}

 	function render(list){
	console.log("전달받은 배열은",list)
	//렌더링.. 작업은 상당히 고달픈 작업이면서, 시간이 많이 걸림.. 따라서 이와 관련되어 나온기술이 Vue, React.js
	let tag ="<table width='100%' border='1px'>";
		tag+="<thead>";
		tag+="<tr>";
		tag+="<th>ID</th>";
		tag+="<th>Name</th>";
		tag+="<th>Email</th>";
		tag+="</tr>";
		tag+="</thead>";
		tag+="<tbody>";
		for(let i=0;i<list.length;i++){
				let member = list[i]
				tag+="<tr>";
				tag+="<td>"+member.id+"</td>";
				tag+="<td>"+member.name+"</td>";
				tag+="<td>"+member.email+"</td>";
				tag+="</tr>";			
		}
		tag+="</tbody>";
		tag +="</table>";
		
	 $(".content").html(tag);
	}
	function regist(){
		//서버의 요청을 시도하되, 비동기로 요청하자!!
		let xhttp = new XMLHttpRequest(); //JS의 비동기 통신객체
		xhttp.onload=function(){
			//서버에서 응답정보가 도착하면 호출되는 익명함수 역할로는 콜백함수
			
			
			/* console.log("서버에서 보내온 데이터는??",this.responseText);
			let memberList=JSON.parse(this.responseText);
			console.log("memberList는",memberList);
			getList(memberList); */
			
			console.log("등록완료");
			
			getList(); //등록완료와 동시에 다시 비동기적 요청 시도
		}
		
		xhttp.open("POST","/ajax/async_regist.jsp");	//요청방법 및 요청 주소 지정
		xhttp.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=utf=8");
		xhttp.send("id="+$("input[name='id']").val()+"&name="+$("input[name='name']").val()+"&email="+$("input[name='email']").val()); //요청 시작
		
							//비동기 요청 출발(이때 요청 시도 자체를 자바스크립트가 하지 않고 브라우저에게 시킴)
							//자바스크립트는 응답정보가 올때까지 대기상태에 빠지지 않고, 자신의 다른일을 할수 있다.(비동기)
							//응답이 올때까지 기다리지 않았기 때문에, 즉 순서를 지키지 않았기 때문에 비동기 방식
							//브라우저가 응답을 받아오면, 자바스크립트에게 알림 .. 이때 자바스크립트의 XMLHttpRequest의 onload속성에 지정한
							//익명함수인 콜백 함수를 호출하게 된다. (누가? js가)
		
	}
	
	//onLoad 효과
	$(()=>{
		$("button").click(()=>{
			regist();
		})
		//문서가 로드되면 기존에 누적된 데이터를 비동기적으로 가져오자.
		getList();
	});
	
</script>

<!--  
<script>
    // 문서가 로드되면 두개의 버튼에 대해 이벤트 연결
    // 화살표 함수 - 기존 함수 정의를 줄이려고 function(){} -> ()=>{}

    $(()=>{
        // 동기버튼에 클릭 이벤트 연결
        $($("form button")[0]).click(()=>{
            $("form").attr({
                action:"/member2/regist.jsp",
                method:"post"
            }); 
        });
    });

    $(()=>{
        // 비동기버튼에 클릭 이벤트 연결
        $($("form button")[1]).click(()=>{
            alert("비동기 방식의 요청시도");   
        });
    });

</script> -->
</head>
<body>
	<div class =container>
		<div class = aside>
            <form >
			<input type="text" placeholder="ID" name="id">
            <input type="text" placeholder="Name" name="name">
            <input type="text" placeholder="Email" name="email">
<!--             <button>동기 등록</button> -->
            <button type ="button">비동기등록</button>
            </form>
		</div>
		<div class = content></div>
	
	</div>

</body>
</html>